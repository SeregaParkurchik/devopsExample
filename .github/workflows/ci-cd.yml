name: CI/CD Pipeline - Yandex Cloud

on:
  push:
    branches: [ main ]

env:
  REGISTRY: cr.yandex
  YC_REGISTRY_ID: your-registry-id  # 행햟햪햣햫햦혝햣 햫햟 ID 쒫썜걣왏 registry  Yandex Cloud

jobs:
  test-backend-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache-dependency-path: backend-go/go.mod
      
      - name: Run Go tests
        run: |
          cd backend-go
          go test -v ./... || echo "No tests found, continuing..."
      
      - name: Build Go binary
        run: |
          cd backend-go
          go build -o app .

  test-frontend-next:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend-next/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend-next
          npm ci
      
      - name: Build Frontend
        run: |
          cd frontend-next
          npm run build

  build-and-push-to-yandex:
    runs-on: ubuntu-latest
    needs: [test-backend-go, test-frontend-next]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Yandex Container Registry
        run: |
          echo "${{ secrets.YC_DOCKER_PASSWORD }}" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex
      
      - name: Build and push Backend to Yandex
        uses: docker/build-push-action@v5
        with:
          context: ./backend-go
          push: true
          tags: |
            cr.yandex/${{ env.YC_REGISTRY_ID }}/backend-go:latest
            cr.yandex/${{ env.YC_REGISTRY_ID }}/backend-go:${{ github.sha }}

      - name: Build and push Frontend to Yandex
        uses: docker/build-push-action@v5
        with:
          context: ./frontend-next
          push: true
          tags: |
            cr.yandex/${{ env.YC_REGISTRY_ID }}/frontend-next:latest
            cr.yandex/${{ env.YC_REGISTRY_ID }}/frontend-next:${{ github.sha }}

  deploy-to-k8s:
    runs-on: ubuntu-latest
    needs: [build-and-push-to-yandex]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubeconfig for Yandex Cloud
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.YC_KUBECONFIG }}" > ~/.kube/config
      
      - name: Update image in Kubernetes deployment
        run: |
          # 뤯쐃쫧쮏쒫혪햣햪 쮏쐄햟향 backend
          kubectl set image deployment/backend-go backend-go=cr.yandex/${{ env.YC_REGISTRY_ID }}/backend-go:${{ github.sha }}
          
          # 뤯쐃쫧쮏쒫혪햣햪 쮏쐄햟향 frontend  
          kubectl set image deployment/frontend-next frontend-next=cr.yandex/${{ env.YC_REGISTRY_ID }}/frontend-next:${{ github.sha }}
          
          # 했햢햣햪 쮏쐃쫧쮏쒫햣햫햦혪
          kubectl rollout status deployment/backend-go
          kubectl rollout status deployment/frontend-next

  health-check:
    runs-on: ubuntu-latest
    needs: [deploy-to-k8s]
    
    steps:
      - name: Check application health
        run: |
          echo "游 Checking deployed applications..."
          echo "Backend API: http://${{ secrets.YC_LOAD_BALANCER_IP }}/api/health"
          echo "Frontend: http://${{ secrets.YC_LOAD_BALANCER_IP }}/"
